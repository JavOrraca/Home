---
layout: post
title: 'Super Bowl 53: Predictive Modeling'
---
Two weeks ago, I entered a Super Bowl LIII predictive analytics competition with my classmate [Kaitlyn Drake](https://www.linkedin.com/in/kaitdrake/) and we had a great time building machine learning models and simulations via R that can be applied to topics beyond sports analytics. I've recently been exploring Shiny, Plotly, and gganimate to make interactive plots, so this was also a great opportunity to produce high-quality web-based interactive visualizations. Kaitlyn was great because prior to this exercise, I knew very little about the NFL and football!

We spent a significant amount of time analyzing various NFL data sets (by team, player, season, etc.), but ultimately, our Poisson regression model relied on four key variables best suited for our game simulations. More variables were considered for our J48 decision tree model. Kaitlyn built the decision tree in WEKA, so this post will only cover the data manipulation, regression modeling, and game simulation aspects of our project executed via R. We didn't use all of the data wrangled, and I won't be going into too much explanation about the data collection and manipulation in this project overview... I created another GitHub repository with all of the data sources and full R code if you want to replicate our analysis: [https://github.com/JavOrraca/NFLSuperBowlPrediction](https://github.com/JavOrraca/NFLSuperBowlPrediction)

**Prerequisites**
* R notebook: I used [Jupyter Lab](https://blog.jupyter.org/jupyterlab-is-ready-for-users-5a6f039b8906) and the repo contains my Jupyter Notebook .ipynb file
* R packages relied upon: dplyr, sqldf, fastDummies (this one is new to me, but worked great for fast conversion of categorical to binary variables), ggplot2, plotly, and gganimate

**Overview & Process**
1. Data Collection & Manipulation
2. Exploration through Visualizations
3. Poisson Regression
4. Simulation Modeling
5. Forecast Conclusions

**1. Data Collection & Manipulation**
<br>After loading several csv files and manipulating, we'll be left with four key data frames containing the following variables: 

```R
str(Teams_2018_Stats)
str(Teams_2018_Valuation)
str(Teams_2018_Valuation_by_Year)
str(Teams_Coach_Tenure)
```

    'data.frame':	532 obs. of  17 variables:
     $ Team                : chr  "Arizona Cardinals" "Arizona Cardinals" "Arizona Cardinals" "Arizona Cardinals" ...
     $ Opponent            : chr  "Washington Redskins" "Los Angeles Rams" "Chicago Bears" "Seattle Seahawks" ...
     $ GameNumber          : int  1 2 3 4 5 6 7 8 9 10 ...
     $ GameLocation        : chr  "HOME" "AWAY" "HOME" "HOME" ...
     $ Team_Score          : int  6 0 14 17 28 17 10 18 14 21 ...
     $ Opponent_Score      : int  24 34 16 20 18 27 45 15 26 23 ...
     $ Team_Passing        : int  145 83 168 171 164 208 154 233 166 128 ...
     $ Team_Rushing        : int  68 54 53 92 56 60 69 88 94 154 ...
     $ Total_Yards         : int  213 137 221 263 220 268 223 321 260 282 ...
     $ Team_Turnovers      : int  2 1 4 1 0 2 5 2 2 2 ...
     $ Opponent_Passing    : int  247 342 194 160 300 216 178 160 212 173 ...
     $ Opponent_Rushing    : int  182 90 122 171 147 195 131 107 118 152 ...
     $ Opponent_Total_Yards: int  429 432 316 331 447 411 309 267 330 325 ...
     $ Opponent_Turnovers  : int  1 1 2 0 5 2 1 0 0 0 ...
     $ Net_Yards           : int  -216 -295 -95 -68 -227 -143 -86 54 -70 -43 ...
     $ Net_Turnovers       : int  1 0 2 1 -5 0 4 2 2 2 ...
     $ Net_Score           : int  -18 -34 -2 -3 10 -10 -35 3 -12 -2 ...
     
    'data.frame':	32 obs. of  3 variables:
     $ Team              : chr  "Los Angeles Rams" "Oakland Raiders" "Atlanta Falcons" "Los Angeles Chargers" ...
     $ Valuation2018inMil: int  29 15 20 11 8 10 14 16 17 18 ...
     $ ValuationChange5Yr: num  3.44 2.49 2.31 2.29 2.16 ...
     
    'data.frame':	448 obs. of  3 variables:
     $ Team     : chr  "Arizona Cardinals" "Arizona Cardinals" "Arizona Cardinals" "Arizona Cardinals" ...
     $ Year     : int  2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 ...
     $ Valuation: int  673 789 888 914 935 919 901 922 961 1000 ...
     
    'data.frame':	32 obs. of  3 variables:
     $ CoachName  : chr  " Bruce AriansÂ " " Dan QuinnÂ " " John HarbaughÂ " " Rex RyanÂ " ...
     $ Team       : chr  "Arizona Cardinals" "Atlanta Falcons" "Baltimore Ravens" "Buffalo Bills" ...
     $ CoachTenure: int  6 4 11 4 8 4 16 3 9 4 ...

The fastDummies package was used to create dummy variables for Teams. Note: The first dummy variable for Team and Opponent can be removed to avoid multicollinearity by including final criteria in the dummy_cols function as "remove_first_dummy = TRUE". Sample code below:

```R
library(fastDummies)

NFL_Trim <- dummy_cols(NFL_Trim, select_columns = "Team")
NFL_Trim[c(20:36,38:39,41:51)] <- NULL
colnames(NFL_Trim)[c(20,21)] <- c("Team_Rams", "Team_Patriots")

str(NFL_Trim)
```
    'data.frame':	532 obs. of  24 variables:
     $ Team                : chr  "Arizona Cardinals" "Arizona Cardinals" "Arizona Cardinals" "Arizona Cardinals" ...
     $ Opponent            : chr  "Washington Redskins" "Los Angeles Rams" "Chicago Bears" "Seattle Seahawks" ...
     $ GameNumber          : int  1 2 3 4 5 6 7 8 9 10 ...
     $ GameLocation        : chr  "HOME" "AWAY" "HOME" "HOME" ...
     $ Team_Score          : int  6 0 14 17 28 17 10 18 14 21 ...
     $ Opponent_Score      : int  24 34 16 20 18 27 45 15 26 23 ...
     $ Team_Passing        : int  145 83 168 171 164 208 154 233 166 128 ...
     $ Team_Rushing        : int  68 54 53 92 56 60 69 88 94 154 ...
     $ Total_Yards         : int  213 137 221 263 220 268 223 321 260 282 ...
     $ Team_Turnovers      : int  2 1 4 1 0 2 5 2 2 2 ...
     $ Opponent_Passing    : int  247 342 194 160 300 216 178 160 212 173 ...
     $ Opponent_Rushing    : int  182 90 122 171 147 195 131 107 118 152 ...
     $ Opponent_Total_Yards: int  429 432 316 331 447 411 309 267 330 325 ...
     $ Opponent_Turnovers  : int  1 1 2 0 5 2 1 0 0 0 ...
     $ Net_Yards           : int  -216 -295 -95 -68 -227 -143 -86 54 -70 -43 ...
     $ Net_Turnovers       : int  1 0 2 1 -5 0 4 2 2 2 ...
     $ Net_Score           : int  -18 -34 -2 -3 10 -10 -35 3 -12 -2 ...
     $ Valuation2018inMil  : int  10 10 10 10 10 10 10 10 10 10 ...
     $ ValuationChange5Yr  : num  2.15 2.15 2.15 2.15 2.15 2.15 2.15 2.15 2.15 2.15 ...
     $ Team_Rams           : int  0 0 0 0 0 0 0 0 0 0 ...
     $ Team_Patriots       : int  0 0 0 0 0 0 0 0 0 0 ...
     $ GameLost            : int  1 1 1 1 0 1 1 0 1 1 ...
     $ GameTie             : int  0 0 0 0 0 0 0 0 0 0 ...
     $ GameWon             : int  0 0 0 0 1 0 0 1 0 0 ...
    
Some important variables that we created for our Poisson regression (and relied on later in our simulations) were the Home vs Away fields (including HomeGoals vs AwayGoals). Code exmaple below:

```R
NFL_Trim$Home <- ifelse(NFL_Trim$GameLocation=="HOME", 1, 0)
NFL_Trim$Away <- ifelse(NFL_Trim$GameLocation=="AWAY", 1, 0)
NFL_Trim$HomeGoals <- ifelse(NFL_Trim$Home==1, NFL_Trim$Team_Score, 0)
NFL_Trim$AwayGoals <- ifelse(NFL_Trim$Away==1, NFL_Trim$Team_Score, 0)
str(NFL_Trim)
```
    'data.frame':	532 obs. of  28 variables:
     $ Team                : chr  "Arizona Cardinals" "Arizona Cardinals" "Arizona Cardinals" "Arizona Cardinals" ...
     $ Opponent            : chr  "Washington Redskins" "Los Angeles Rams" "Chicago Bears" "Seattle Seahawks" ...
     $ GameNumber          : int  1 2 3 4 5 6 7 8 9 10 ...
     $ GameLocation        : chr  "HOME" "AWAY" "HOME" "HOME" ...
     $ Team_Score          : int  6 0 14 17 28 17 10 18 14 21 ...
     $ Opponent_Score      : int  24 34 16 20 18 27 45 15 26 23 ...
     $ Team_Passing        : int  145 83 168 171 164 208 154 233 166 128 ...
     $ Team_Rushing        : int  68 54 53 92 56 60 69 88 94 154 ...
     $ Total_Yards         : int  213 137 221 263 220 268 223 321 260 282 ...
     $ Team_Turnovers      : int  2 1 4 1 0 2 5 2 2 2 ...
     $ Opponent_Passing    : int  247 342 194 160 300 216 178 160 212 173 ...
     $ Opponent_Rushing    : int  182 90 122 171 147 195 131 107 118 152 ...
     $ Opponent_Total_Yards: int  429 432 316 331 447 411 309 267 330 325 ...
     $ Opponent_Turnovers  : int  1 1 2 0 5 2 1 0 0 0 ...
     $ Net_Yards           : int  -216 -295 -95 -68 -227 -143 -86 54 -70 -43 ...
     $ Net_Turnovers       : int  1 0 2 1 -5 0 4 2 2 2 ...
     $ Net_Score           : int  -18 -34 -2 -3 10 -10 -35 3 -12 -2 ...
     $ Valuation2018inMil  : int  10 10 10 10 10 10 10 10 10 10 ...
     $ ValuationChange5Yr  : num  2.15 2.15 2.15 2.15 2.15 2.15 2.15 2.15 2.15 2.15 ...
     $ Team_Rams           : int  0 0 0 0 0 0 0 0 0 0 ...
     $ Team_Patriots       : int  0 0 0 0 0 0 0 0 0 0 ...
     $ GameLost            : int  1 1 1 1 0 1 1 0 1 1 ...
     $ GameTie             : int  0 0 0 0 0 0 0 0 0 0 ...
     $ GameWon             : int  0 0 0 0 1 0 0 1 0 0 ...
     $ Home                : num  1 0 1 1 0 0 1 1 0 1 ...
     $ Away                : num  0 1 0 0 1 1 0 0 1 0 ...
     $ HomeGoals           : num  6 0 14 17 0 0 10 18 0 21 ...
     $ AwayGoals           : num  0 0 0 0 28 17 0 0 14 0 ...
    
I then used the sqldf package to run SQL functions within the R environment, see below:

```R
library(sqldf)

WhenWonbyTeam <- sqldf("SELECT Team, AVG(Team_Score) AS PointsAvgWhenWon, AVG(Total_Yards) AS YardsAvgWhenWon, AVG(Net_Yards) AS YardsAvgNetWhenWon FROM NFL_Trim WHERE GameWon = 1 GROUP BY Team")

WhenAwaybyTeam <- sqldf("SELECT Team, AVG(Team_Score) AS PointsAvgWhenAway, AVG(Total_Yards) AS YardsAvgWhenAway, AVG(Net_Yards) AS YardsAvgNetWhenAway FROM NFL_Trim WHERE GameLocation = 'AWAY' GROUP BY Team")

WhenWonAwaybyTeam <- sqldf("SELECT Team, AVG(Team_Score) AS PointsAvgWhenWonAway, AVG(Total_Yards) AS YardsAvgWhenWonAway, AVG(Net_Yards) AS YardsAvgNetWhenWonAway FROM NFL_Trim WHERE GameLocation = 'AWAY' AND GameWon = 1 GROUP BY Team")

# Left join all using plyr package and re-order columns  
library(plyr)
NFL_ConditionalTbl <- join_all(list(WhenWonbyTeam, WhenAwaybyTeam, WhenWonAwaybyTeam), by="Team", type="left")
NFL_ConditionalTbl <- NFL_ConditionalTbl[,c(1,2,5,8,3,6,9,4,7,10)]

# Since SF 49ers won no games away, clean up NAs
NFL_ConditionalTbl[is.na(NFL_ConditionalTbl)] <- 0

# Re-load dplyr in case any plyr functions masked dplyr functions
library(dplyr)

str(NFL_ConditionalTbl)
```
    'data.frame':	32 obs. of  10 variables:
     $ Team                  : chr  "Arizona Cardinals" "Atlanta Falcons" "Baltimore Ravens" "Buffalo Bills" ...
     $ PointsAvgWhenWon      : num  22 32 27.3 26.8 30.3 ...
     $ PointsAvgWhenAway     : num  15.9 22.2 21.5 14.8 21.5 ...
     $ PointsAvgWhenWonAway  : num  24 32 23.8 34 27 ...
     $ YardsAvgWhenWon       : num  285 446 390 331 365 ...
     $ YardsAvgWhenAway      : num  225 390 378 285 375 ...
     $ YardsAvgWhenWonAway   : num  268 469 385 372 372 ...
     $ YardsAvgNetWhenWon    : num  -61 36.3 156.6 67.2 33.7 ...
     $ YardsAvgNetWhenAway   : num  -160.6 29.4 85.5 -20.4 25.6 ...
     $ YardsAvgNetWhenWonAway: num  -118.5 57.3 205 126 54.5 ...

We create one _more_ data frame, NFL_by_Team, from existing data objects in our R environment:

```R
NFL_by_Team <- NFL_Trim %>%
    group_by(Team) %>%
    transmute(
        GamesTotal = max(GameNumber),
        GamesTotalLost = sum(GameLost),
        GamesTotalTied = sum(GameTie),
        GamesTotalWon = sum(GameWon),
        PointsAvgPerGame = mean(Team_Score),
        PointsTotal = sum(Team_Score),
        YardsTotalPassing = sum(Team_Passing),
        YardsTotalRushing = sum(Team_Rushing),
        YardsTotal = sum(Total_Yards),
        YardsAvg = mean(Total_Yards),
        YardsTotalNet = sum(Net_Yards),
        YardsAvgNet = mean(Net_Yards),
        TurnoversTotal = sum(Team_Turnovers),
        TurnoversAvg = mean(Team_Turnovers),
        Valuation2018 = mean(Valuation2018inMil),
        ValuationChange5Yr = mean(ValuationChange5Yr)
    )

# Run distinct function to remove duplicate instances carried from NFL_Trim
NFL_by_Team <- distinct(NFL_by_Team, Team, .keep_all = TRUE)

# Left join to NFL conditional sum / avg table and re-order columns
NFL_by_Team <- left_join(NFL_by_Team, NFL_ConditionalTbl, by=c("Team" = "Team"))
NFL_by_Team <- as.data.frame(NFL_by_Team)
NFL_by_Team <- NFL_by_Team[,c(1:5,7,6,18:20,8:11,21:23,12:13,24:26,14:17)]
str(NFL_by_Team)
```
    'data.frame':	32 obs. of  26 variables:
     $ Team                  : chr  "Arizona Cardinals" "Atlanta Falcons" "Baltimore Ravens" "Buffalo Bills" ...
     $ GamesTotal            : num  16 16 17 16 16 17 16 16 18 16 ...
     $ GamesTotalLost        : int  13 9 7 10 9 5 10 8 7 10 ...
     $ GamesTotalTied        : int  0 0 0 0 0 0 0 1 0 0 ...
     $ GamesTotalWon         : int  3 7 10 6 7 12 6 7 11 6 ...
     $ PointsTotal           : int  225 414 406 269 376 436 368 359 385 329 ...
     $ PointsAvgPerGame      : num  14.1 25.9 23.9 16.8 23.5 ...
     $ PointsAvgWhenWon      : num  22 32 27.3 26.8 30.3 ...
     $ PointsAvgWhenAway     : num  15.9 22.2 21.5 14.8 21.5 ...
     $ PointsAvgWhenWonAway  : num  24 32 23.8 34 27 ...
     $ YardsTotalPassing     : int  2523 4653 3697 2794 3836 3855 3290 4007 4012 3695 ...
     $ YardsTotalRushing     : int  1342 1573 2531 1984 2136 2003 1682 1893 2177 1907 ...
     $ YardsTotal            : int  3865 6226 6228 4778 5972 5858 4972 5900 6189 5602 ...
     $ YardsAvg              : num  242 389 366 299 373 ...
     $ YardsAvgWhenWon       : num  285 446 390 331 365 ...
     $ YardsAvgWhenAway      : num  225 390 378 285 375 ...
     $ YardsAvgWhenWonAway   : num  268 469 385 372 372 ...
     $ YardsTotalNet         : int  -1876 74 1298 72 321 763 -1646 -388 163 -240 ...
     $ YardsAvgNet           : num  -117.25 4.62 76.35 4.5 20.06 ...
     $ YardsAvgNetWhenWon    : num  -61 36.3 156.6 67.2 33.7 ...
     $ YardsAvgNetWhenAway   : num  -160.6 29.4 85.5 -20.4 25.6 ...
     $ YardsAvgNetWhenWonAway: num  -118.5 57.3 205 126 54.5 ...
     $ TurnoversTotal        : int  28 18 23 32 22 24 17 24 18 21 ...
     $ TurnoversAvg          : num  1.75 1.12 1.35 2 1.38 ...
     $ Valuation2018         : num  10 20 19 1 12 26 3 4 32 22 ...
     $ ValuationChange5Yr    : num  2.15 2.31 1.73 1.71 1.84 ...
    
**2. Exploration through Visualizations**
<br>I'm having issues incorporating the Plotly and gganimate interactive plots / animations to this Markdown script, but on the full GitHub repo you can find the [interactive plots as HTML files](https://github.com/JavOrraca/NFLSuperBowlPrediction/tree/master/Sample%20Visualizations). Here are some static examples of ggplot2 + plotly charts:

![](https://raw.githubusercontent.com/JavOrraca/Home/gh-pages/assets/img/Plot1.png)

![](https://raw.githubusercontent.com/JavOrraca/Home/gh-pages/assets/img/Plot2.png)

**3. Poisson Regression**
<br>The most important step in our analysis includes creating a new data frame (via row-binding of two data frames) and then running the data through a Poisson regression (link-log Poisson glm).

```R
NFL_Poisson <- rbind(
    data.frame(Points=NFL_Trim$HomeGoals,
               Team=NFL_Trim$Team,
               Opponent=NFL_Trim$Opponent,
               Home=1),
    data.frame(Points=NFL_Trim$AwayGoals,
               Team=NFL_Trim$Opponent,
               Opponent=NFL_Trim$Team,
               Home=0)) %>%
glm(Points ~ Home + Team + Opponent, family=poisson(link=log), data=.)
summary(NFL_Poisson)
```
Similar to logistic regression, we need to exponentiate the parameter Estimate values to make sense of the output. A positive Estimate value from the regression output implies more points (e<sup>x</sup>>1∀x>0), while values closer to zero represent more neutral effects (e<sup>0</sup>=1). The Home variable has an Estimate of 0.094649. Historically when predicing NFL scores, Home would have captured the fact that home teams generally score more points than away teams. However, in exponentiating the Estimate coefficient for Home, the 2018 NFL data indicates that home teams were only 9.9% more likely to score (e<sup>0.094649</sup>=1.099).

The Los Angeles Rams have a Team estimate coefficient of 0.601312, while the New England Patriots have a 0.389060. This indicates that the Los Angeles Rams are generally better scorers than the "average" NFL team (and well... the New England Patriots are _also_ better scorers than the average NFL team, but _not as good of scorers_ as the Los Angeles Rams). The Opponent values penalize and reward teams based on the quality of their opposition. This mimics the defensive strength of each team (Los Angeles Rams: 0.128184; New England Patriots: 0.077337). In this case, you are less likely to score against the New England Patriots.

**4. Simulation Modeling**
<br>To predict the likelihood of the outcome of our Super Bowl 53 prediction, one of the finalists would (or should) be assigned a home team advantage. While both Super Bowl 53 teams are playing away, the Los Angeles Rams do not have as wide-reaching of a fanbase as the Patriots, and sports forecasters / ticket brokers are predicting that the majority of the fanbase present at Super Bowl 53 will be Patriots fans. As such, we'll assign the Patriots with the home team advantage.

We will pass the teams into the NFL_Poisson regression model and the output returns the expected average number of points for the team (we need to run it twice to calculate the expected average number of points for each team separately). Below is the code and results for how many points we expect the Los Angeles Rams and the New England Patriots to score, giving the home team advantage to the Patriots.

```R
predict(NFL_Poisson,
        data.frame(Home=1, Team="New England Patriots",
                   Opponent="Los Angeles Rams"), type="response")
```
14.3442631436516

```R
predict(NFL_Poisson,
        data.frame(Home=0, Team="Los Angeles Rams",
                   Opponent="New England Patriots"), type="response")
```
15.3345232802124

The above results show a super tight range, predicting that the Los Angeles Rams will beat the New England Patriots 15 to 14, depsite the Patriots having the home team advantage. Given the tight above results, we'll create a Super Bowl simulation function as follows:

```R
# Create function (and prepare underlying data frames) for simulation
SuperBowl_Simulate <- function(NFL_Model, HomeTeam, AwayTeam, MaxPoints=40){
    HomePointsAvg <- predict(NFL_Model,
                            data.frame(Home=1, Team=HomeTeam,
                                       Opponent=AwayTeam), type="response")
    AwayPointsAvg <- predict(NFL_Model,
                            data.frame(Home=0, Team=AwayTeam,
                                       Opponent=HomeTeam), type="response")
    dpois(0:MaxPoints, HomePointsAvg) %o% dpois(0:MaxPoints, AwayPointsAvg) 
}

# Simulate for the teams at Super Bowl 53, listing the Home-advantage team first.
SuperBowl_Simulate(NFL_Poisson, "New England Patriots", "Los Angeles Rams", MaxPoints=16)
```

The code above produces a matrix of probabilities of the New England Patriots (rows of the matrix) and the Los Angeles Rams (matrix columns) scoring a specific number of points. For example, along the diagonal, both teams have the same number of points (e.g. P(0-0) = 1.290229e-13). We can calculate the odds of draw by summing all the diagonal entries. Everything below the diagonal represents a Patriots win (e.g P(8-0) = 3.198777e-09). Using matrix manipulation functions, we can perform these types of calculations to understand the chances of winning.

```R
PatriotsVsRams <- SuperBowl_Simulate(NFL_Poisson, "New England Patriots", "Los Angeles Rams", MaxPoints=40)
# Chances of a Patriots win
sum(PatriotsVsRams[lower.tri(PatriotsVsRams)])
```
0.391993996454314

```R
# Chances of a Tie, even though this is an impossibility for the Super Bowl
sum(diag(PatriotsVsRams))
```
0.0723591319608067

```R
# Chances of a Rams win
sum(PatriotsVsRams[upper.tri(PatriotsVsRams)])
```
0.535646822597374

**5. Forecast Conclusions**
* Our predictions indicate that the Super Bowl will be an extremely close game
* Even with the New England Patriots having the home team advantage (due to heavier fanbase predicted to be Super Bowl 53), they're projected to lose
* Our regression analysis and simulations favor the Los Angeles Rams narrowly leading with a final score of 15-14
* The Rams have a 53.6% chance of winning based on the game simulation output

**Acknowledgements**
<br>Our game simulation method was derived from one of David Sheehan's GitHub repos, [Predicting Futbol Results With Statistical Modelling](https://dashee87.github.io/data%20science/football/r/predicting-football-results-with-statistical-modelling/).
